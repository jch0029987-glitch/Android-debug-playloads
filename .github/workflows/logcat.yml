name: Build and Get Logs

on: workflow_dispatch

jobs:
  build-and-log:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Java
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '17'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@v4   # Latest version in 2026
      # Optional: pin a specific version like '9.2.1' if needed
      # with:
      #   gradle-version: '9.2.1'

    - name: Build Debug APK
      run: gradle assembleDebug --stacktrace   # Note: 'gradle' not './gradlew'

    - name: Create and Start Emulator
      run: |
        echo "y" | sdkmanager "system-images;android-33;google_apis;x86_64"
        echo "y" | sdkmanager "platform-tools" "platforms;android-33"
        echo "no" | avdmanager create avd -n test_emulator -k "system-images;android-33;google_apis;x86_64" --force
        
        $ANDROID_HOME/emulator/emulator -avd test_emulator -no-snapshot-save -no-window -no-audio -no-boot-anim &

    - name: Wait for Emulator to Boot Fully
      run: |
        adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 5; done; echo "Emulator booted"'
        sleep 20
        adb devices

    - name: Install APK
      run: |
        APK=$(ls app/build/outputs/apk/debug/app-debug.apk 2>/dev/null || find . -name "*-debug.apk" | head -1)
        if [[ -z "$APK" ]]; then
          echo "ERROR: No debug APK found!"
          exit 1
        fi
        echo "Found APK: $APK"
        adb install "$APK"

    - name: Clear and Start Capturing Logs in Background
      run: |
        adb logcat -c
        adb logcat > full_logcat.txt 2>&1 &
        echo $! > logcat_pid.txt
        echo "Logcat streaming started"

    - name: Launch App and Wait for Potential Crash
      run: |
        adb shell am start -n "com.jch.debugclient/.MainActivity" || true
        echo "Waiting for app to run or crash (60s)..."
        sleep 60
        adb shell am force-stop com.jch.debugclient || true

    - name: Stop Logcat Capture
      run: |
        if [[ -f logcat_pid.txt ]]; then
          kill $(cat logcat_pid.txt) || true
        fi
        sleep 5

    - name: Show Filtered Crash Logs
      run: |
        echo "=== FILTERED CRASH LOGS ==="
        if [[ -f full_logcat.txt ]]; then
          grep -E "(E/|FATAL|AndroidRuntime|Exception|jch.debugclient)" full_logcat.txt | tail -300 || echo "No matching logs"
        fi

    - name: Upload Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: debug-logs-and-apk
        path: |
          full_logcat.txt
          app/build/outputs/apk/debug/app-debug.apk
          **/*-debug.apk
